<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Smart Expense Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>

  <!-- Top Navigation -->
  <nav class="navbar navbar-expand-lg navbar-custom shadow-sm mb-4">
    <div class="container-fluid">
      <a class="navbar-brand fw-bold" href="/">üíº Smart Expense Tracker</a>
      <div>
        {% if session.get("user_id") %}
          <a href="/logout" class="btn btn-light">Logout</a>
        {% else %}
          <a href="/login" class="btn btn-outline-light me-2">Login</a>
          <a href="/register" class="btn btn-light">Register</a>
        {% endif %}
      </div>
    </div>
  </nav>

  <div class="container">

    <!-- Filters + Budget Row -->
    <div class="row">
      <div class="col-lg-6">
        <div class="card">
          <div class="section-title">üìÖ Filter by Date</div>
          <form method="get">
            <select name="filter" onchange="this.form.submit()" class="form-select">
              <option value="all" {% if selected_filter == 'all' %}selected{% endif %}>All Time</option>
              <option value="month" {% if selected_filter == 'month' %}selected{% endif %}>This Month</option>
              <option value="week" {% if selected_filter == 'week' %}selected{% endif %}>This Week</option>
              <option value="fortnight" {% if selected_filter == 'fortnight' %}selected{% endif %}>Last 14 Days</option>
            </select>
          </form>
        </div>
      </div>

      {% if session.get("user_id") %}
      <div class="col-lg-6">
        <div class="card">
          <div class="section-title">üí∞ Monthly Budget</div>
          <form action="/set_budget" method="POST" class="row g-3 align-items-center">
            <div class="col-auto">
              <input type="number" step="0.01" name="budget" class="form-control" value="{{ budget or '' }}" placeholder="Set Budget" required>
            </div>
            <div class="col-auto">
              <button type="submit" class="btn btn-outline-primary">Update</button>
            </div>
            {% if budget is not none %}
            <div class="col-auto">
              <span class="badge">Remaining: ${{ "%.2f"|format(remaining) }}</span>
            </div>
            {% endif %}
          </form>
        </div>
      </div>
      {% endif %}
    </div>

    <!-- Summary + Chart -->
    <div class="row">
      <div class="col-lg-6">
        <div class="card">
          <div class="section-title">üìä Category Breakdown</div>
          <div class="chart-container">
            <canvas id="expenseChart"></canvas>
          </div>
        </div>
      </div>

      <div class="col-lg-6">
        <div class="card">
          <div class="section-title">üí∏ Total Spent</div>
          <p class="lead">Total: ${{ total }}</p>
          <ul class="list-group list-group-flush">
            {% for cat, amt in grouped.items() %}
            <li class="list-group-item d-flex justify-content-between">
              <span>{{ cat }}</span>
              <strong>${{ "%.2f"|format(amt) }}</strong>
            </li>
            {% endfor %}
          </ul>
        </div>
      </div>
    </div>

    <!-- Add Expense + Upload -->
    {% if session.get("user_id") %}
    <div class="card">
      <div class="section-title">‚ûï Add New Expense</div>
      <form action="/add" method="POST" class="row g-3">
        <div class="col-md-3"><input type="date" name="date" class="form-control" required></div>
        <div class="col-md-3"><input type="text" name="category" class="form-control" placeholder="Category" required></div>
        <div class="col-md-3"><input type="text" name="description" class="form-control" placeholder="Description" required></div>
        <div class="col-md-3"><input type="number" step="0.01" name="amount" class="form-control" placeholder="Amount" required></div>
        <div class="col-12 text-end">
          <button type="submit" class="btn btn-success">Add Expense</button>
        </div>
      </form>
    </div>

    <div class="card">
      <div class="section-title">üìÅ Upload CSV</div>
      <form action="/upload" method="POST" enctype="multipart/form-data" class="input-group">
        <input type="file" name="file" accept=".csv" class="form-control" required>
        <button type="submit" class="btn btn-outline-success">Upload</button>
      </form>
    </div>
    {% endif %}

    <!-- Expense Table -->
    <div class="card">
      <div class="section-title">üìã Expense Table</div>
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th>Date</th>
              <th>Category</th>
              <th>Description</th>
              <th>Amount</th>
            </tr>
          </thead>
          <tbody>
            {% for exp in expenses %}
            <tr>
              <td>{{ exp.Date }}</td>
              <td>{{ exp.Category }}</td>
              <td>{{ exp.Description }}</td>
              <td>${{ "%.2f"|format(exp.Amount) }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

  </div>

  <!-- Chart Script -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const ctx = document.getElementById('expenseChart');
    new Chart(ctx, {
      type: 'pie',
      data: {
        labels: {{ chart_labels | tojson }},
        datasets: [{
          label: 'Spending ($)',
          data: {{ chart_data | tojson }},
          backgroundColor: [
            '#e9d5ff', '#d8b4fe', '#c084fc',
            '#a855f7', '#9333ea', '#7e22ce', '#6b21a8'
          ],
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
              boxWidth: 16,
              padding: 10
            }
          }
        }
      }
    });
  </script>
</body>
</html>
